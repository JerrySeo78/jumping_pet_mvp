<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Jumping Pet - Ï†êÌïëÌé´</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  background: #1a1a2e;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: 'Segoe UI', sans-serif;
  touch-action: none;
  -webkit-user-select: none;
  user-select: none;
}
canvas { display: block; max-width: 100vw; max-height: 100vh; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = 400, H = 720;
canvas.width = W; canvas.height = H;

function resizeCanvas() {
  const s = Math.min(window.innerWidth / W, window.innerHeight / H);
  canvas.style.width = (W * s) + 'px';
  canvas.style.height = (H * s) + 'px';
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Constants
const LANE_X = [W * 0.3, W * 0.7];
const PLAT_GAP = 105;
const STATE = { MENU: 0, PLAY: 1, OVER: 2 };
const C = {
  sky1:'#d4edf9', sky2:'#e8f4fd', sky3:'#f0e6f6',
  ice:'#b8dff0', iceDeep:'#7bbcd6',
  purpleDeep:'#7a5ba8', green:'#5cb85c',
  pinkBg:'#fde0ef', candy:'#c77dff', brown:'#6b4226', bone:'#f5deb3',
};

// State
let gs = STATE.MENU, score = 0, highScore = +localStorage.getItem('jpH')||0;
let level = 1, heightM = 0, candies = 0, fever = 0, isFever = false, feverT = 0;
let camY = 0, step = 0, platforms = [], particles = [], gt = 0, shakeT = 0;
let jumpA = { on: false, t: 0, dur: 0, fx: 0, fy: 0, tx: 0, ty: 0, pk: 0 };
let jumpTxt = { on: false, t: 0 };
let falling = false;

const pet = { lane: 0, x: LANE_X[0], y: 0, face: 1 };

// Platform gen
function mkPlat(i) {
  const lane = i === 0 ? 0 : Math.random() < 0.5 ? 0 : 1;
  return {
    i, lane, x: LANE_X[lane], y: -i * PLAT_GAP,
    w: 72, h: 18,
    type: i > 4 && Math.random() < 0.15 ? 'purple' : 'normal',
    hasCandy: i > 0 && Math.random() < 0.13,
    candyGot: false, broken: false, breakT: 0,
  };
}

function initPlats() {
  platforms = [];
  for (let i = 0; i < 30; i++) platforms.push(mkPlat(i));
}

function ensurePlats() {
  const mx = platforms[platforms.length - 1].i;
  for (let i = mx + 1; i <= step + 25; i++) platforms.push(mkPlat(i));
  platforms = platforms.filter(p => p.y - camY < H + 200);
}

function getPlat(s) { return platforms.find(p => p.i === s); }

// Jump
function startJump(fx, fy, tx, ty) {
  const dx = Math.abs(tx - fx);
  const dy = fy - ty;
  jumpA = {
    on: true, t: 0, dur: dx < 10 ? 16 : 20,
    fx, fy, tx, ty,
    pk: Math.min(fy, ty) - Math.max(dy * 0.3 + 60, 80),
  };
}

function updateJump() {
  if (!jumpA.on) return;
  jumpA.t++;
  const p = jumpA.t / jumpA.dur;
  if (p >= 1) {
    jumpA.on = false;
    pet.x = jumpA.tx; pet.y = jumpA.ty;
    if (!falling) onLand();
    return;
  }
  const q = 1 - p;
  pet.x = q * jumpA.fx + p * jumpA.tx;
  pet.y = q * q * jumpA.fy + 2 * q * p * jumpA.pk + p * p * jumpA.ty;
}

function onLand() {
  const pl = getPlat(step);
  if (!pl) return;
  if (pl.hasCandy && !pl.candyGot) {
    pl.candyGot = true; candies++; score += 50;
    spawnP(pl.x, pl.y, C.candy, 6);
  }
  if (pl.type === 'purple') {
    pl.broken = true; shakeT = 4;
    spawnP(pl.x, pl.y, C.purpleDeep, 8);
  }
  score += isFever ? 20 : 10;
  heightM = Math.max(heightM, Math.floor(step * PLAT_GAP / 10));
  level = Math.floor(heightM / 100) + 1;
  if (!isFever) {
    fever = Math.min(100, fever + 4);
    if (fever >= 100) { isFever = true; feverT = 300; spawnP(pet.x, pet.y, '#ff4081', 15); }
  }
  spawnP(pet.x, pet.y + 10, '#fff', 3);
}

// Input
function handleInput(side) {
  if (gs === STATE.MENU) { startGame(); return; }
  if (gs === STATE.OVER) { startGame(); return; }
  if (jumpA.on || falling) return;

  // Find next platform on tapped side
  let target = null;
  for (let i = step + 1; i <= step + 4; i++) {
    const p = getPlat(i);
    if (p && p.lane === side && !p.broken) { target = p; break; }
  }

  if (!target) {
    // Wrong side - fall
    falling = true;
    const fallX = LANE_X[side];
    jumpA = { on: true, t: 0, dur: 28, fx: pet.x, fy: pet.y, tx: fallX, ty: pet.y + 350, pk: pet.y - 60 };
    setTimeout(() => {
      gs = STATE.OVER; falling = false;
      if (score > highScore) { highScore = score; localStorage.setItem('jpH', '' + highScore); }
    }, 480);
    return;
  }

  step = target.i;
  pet.lane = side;
  pet.face = side === 1 ? 1 : -1;
  startJump(pet.x, pet.y, target.x, target.y);
  ensurePlats();
}

function getPos(cx, cy) {
  const r = canvas.getBoundingClientRect();
  return { x: (cx - r.left) / r.width * W, y: (cy - r.top) / r.height * H };
}
canvas.addEventListener('touchstart', e => { e.preventDefault(); const p = getPos(e.touches[0].clientX, e.touches[0].clientY); handleInput(p.x > W/2 ? 1 : 0); });
canvas.addEventListener('mousedown', e => { const p = getPos(e.clientX, e.clientY); handleInput(p.x > W/2 ? 1 : 0); });
document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft' || e.key === 'a') handleInput(0);
  if (e.key === 'ArrowRight' || e.key === 'd') handleInput(1);
  if ((e.key === ' ' || e.key === 'Enter') && gs !== STATE.PLAY) handleInput(0);
});

// Particles
function spawnP(x, y, color, n = 5) {
  for (let i = 0; i < n; i++) particles.push({
    x, y, vx: (Math.random()-.5)*6, vy: -Math.random()*4-1,
    life: 1, dec: .025+Math.random()*.02, sz: 3+Math.random()*4, color
  });
}

// Draw helpers
function rr(x,y,w,h,r) { ctx.beginPath(); ctx.roundRect(x,y,w,h,r); ctx.fill(); }

function drawBG() {
  const g = ctx.createLinearGradient(0,0,0,H);
  if (isFever) { g.addColorStop(0,C.pinkBg); g.addColorStop(1,'#f8bbd0'); }
  else { g.addColorStop(0,C.sky1); g.addColorStop(.5,C.sky2); g.addColorStop(1,C.sky3); }
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

  // Center line
  ctx.strokeStyle = 'rgba(180,210,230,0.3)'; ctx.lineWidth = 1;
  ctx.setLineDash([8,8]);
  ctx.beginPath(); ctx.moveTo(W/2,0); ctx.lineTo(W/2,H); ctx.stroke();
  ctx.setLineDash([]);

  // Snow
  ctx.globalAlpha = .25; ctx.fillStyle = '#fff';
  for (let i = 0; i < 20; i++) {
    const sx = (i*37+camY*.04*(i%3+1))%W, sy = (i*53+camY*.06*(i%2+1))%H;
    ctx.beginPath(); ctx.arc(sx,sy,1+(i%3),0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1;

  // Side mounds
  ctx.globalAlpha = .1; ctx.fillStyle = C.ice;
  const off = (-camY*.12)%300;
  for (let i = 0; i < 5; i++) {
    const my = (i*200+off)%(H+100)-50;
    ctx.beginPath(); ctx.ellipse(-15,my,50,35,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(W+15,my+80,50,35,0,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1;

  // Icicles
  ctx.fillStyle = 'rgba(200,230,245,0.15)';
  for (let i = 0; i < 4; i++) {
    const iy = (i*250+off*1.5)%(H+100)-50;
    ctx.beginPath(); ctx.moveTo(0,iy); ctx.lineTo(15,iy); ctx.lineTo(8,iy+40); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(W,iy+60); ctx.lineTo(W-15,iy+60); ctx.lineTo(W-8,iy+100); ctx.closePath(); ctx.fill();
  }

  // Cat igloo (background deco)
  const interval = 2000;
  const base = Math.round(camY/interval)*interval - 200;
  for (let i = -1; i <= 1; i++) {
    const sy = base + i*interval - camY;
    if (sy < -250 || sy > H+50) continue;
    ctx.globalAlpha = .1; ctx.fillStyle = '#d8c0e8';
    ctx.beginPath(); ctx.arc(W/2,sy,55,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.moveTo(W/2-42,sy-42); ctx.lineTo(W/2-55,sy-95); ctx.lineTo(W/2-12,sy-52); ctx.fill();
    ctx.beginPath(); ctx.moveTo(W/2+42,sy-42); ctx.lineTo(W/2+55,sy-95); ctx.lineTo(W/2+12,sy-52); ctx.fill();
    ctx.fillStyle = '#c0a8d8';
    ctx.beginPath(); ctx.arc(W/2-16,sy-8,4,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(W/2+16,sy-8,4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#b8a0d0';
    ctx.beginPath(); ctx.arc(W/2,sy+38,20,Math.PI,0); ctx.fill();
    ctx.globalAlpha = 1;
  }
}

function drawPlat(p) {
  const sy = p.y - camY;
  if (sy < -40 || sy > H+40) return;
  ctx.save();
  if (p.broken) {
    ctx.globalAlpha = Math.max(0,1-p.breakT);
    ctx.translate(p.x, sy+p.h/2);
    ctx.rotate(p.breakT*.8*(p.lane?1:-1));
    ctx.translate(-p.x, -(sy+p.h/2));
  }
  const px = p.x-p.w/2, py = sy;
  if (p.type === 'purple') {
    ctx.fillStyle = '#e0d0f0'; rr(px-2,py-2,p.w+4,p.h+4,10);
    ctx.fillStyle = '#d4c4e8'; rr(px,py,p.w,p.h*.5,[8,8,2,2]);
    ctx.fillStyle = C.purpleDeep; rr(px+2,py+p.h*.35,p.w-4,p.h*.65,[2,2,8,8]);
    ctx.fillStyle = 'rgba(255,255,255,.4)'; rr(px+8,py+3,p.w*.25,3,2);
  } else {
    ctx.fillStyle = '#e8f5ff'; rr(px-2,py-2,p.w+4,p.h+4,10);
    ctx.fillStyle = '#fff'; rr(px,py,p.w,p.h*.6,[8,8,2,2]);
    ctx.fillStyle = C.iceDeep; rr(px+2,py+p.h*.4,p.w-4,p.h*.6,[2,2,8,8]);
    ctx.fillStyle = 'rgba(255,255,255,.6)'; rr(px+8,py+3,p.w*.3,4,2);
  }
  if (p.hasCandy && !p.candyGot) {
    const b = Math.sin(gt*.08+p.i)*3;
    ctx.fillStyle = C.candy;
    rr(p.x-7,py-18+b,14,10,3);
    ctx.beginPath(); ctx.moveTo(p.x-7,py-15+b); ctx.lineTo(p.x-12,py-18+b); ctx.lineTo(p.x-7,py-11+b); ctx.fill();
    ctx.beginPath(); ctx.moveTo(p.x+7,py-15+b); ctx.lineTo(p.x+12,py-18+b); ctx.lineTo(p.x+7,py-11+b); ctx.fill();
    ctx.fillStyle = 'rgba(255,255,255,.5)'; rr(p.x-3,py-16+b,4,3,1);
  }
  ctx.restore();
}

function drawPet() {
  const sx = pet.x, sy = pet.y - camY;
  ctx.save(); ctx.translate(sx, sy);
  let scX=1, scY=1;
  if (jumpA.on) {
    const p = jumpA.t/jumpA.dur;
    if (p<.3){scX=.85;scY=1.2;}else if(p>.7){scX=1.1;scY=.9;}
  }
  ctx.scale(scX*pet.face, scY);
  if (isFever) {
    ctx.strokeStyle='rgba(255,200,240,.5)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(0,-10,30+Math.sin(gt*.15)*3,0,Math.PI*2); ctx.stroke();
    ctx.shadowColor='#f8a4c8'; ctx.shadowBlur=12;
  }
  // Body
  ctx.fillStyle='#f5e6d0';
  ctx.beginPath(); ctx.ellipse(0,-8,16,18,0,0,Math.PI*2); ctx.fill();
  // Shirt
  ctx.fillStyle='#4a9bd9'; rr(-14,-2,28,18,6);
  // Arms
  ctx.fillStyle='#f5e6d0';
  ctx.beginPath(); ctx.ellipse(-16,4,6,8,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(16,4,6,8,0,0,Math.PI*2); ctx.fill();
  // Head
  ctx.fillStyle='#f5e6d0';
  ctx.beginPath(); ctx.arc(0,-22,15,0,Math.PI*2); ctx.fill();
  // Ears
  ctx.beginPath(); ctx.arc(-10,-35,7,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(10,-35,7,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#e8c4a0';
  ctx.beginPath(); ctx.arc(-10,-35,4,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(10,-35,4,0,Math.PI*2); ctx.fill();
  // Hat
  ctx.fillStyle='#2d8f4e';
  ctx.beginPath(); ctx.arc(0,-30,13,Math.PI,0); ctx.fill();
  rr(-14,-32,28,8,3);
  ctx.fillStyle='#1a6b35';
  for(let i=-10;i<10;i+=5)ctx.fillRect(i,-32,2,6);
  ctx.fillStyle='#fff';
  ctx.beginPath(); ctx.arc(0,-42,5,0,Math.PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle='#2c2c2c';
  ctx.beginPath(); ctx.arc(-5,-23,2.5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(5,-23,2.5,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff';
  ctx.beginPath(); ctx.arc(-4,-24,1,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(6,-24,1,0,Math.PI*2); ctx.fill();
  // Nose
  ctx.fillStyle='#8B6F5E';
  ctx.beginPath(); ctx.arc(0,-19,2,0,Math.PI*2); ctx.fill();
  // Mouth
  ctx.strokeStyle='#8B6F5E'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.arc(-2,-17,3,0,Math.PI*.7); ctx.stroke();
  ctx.beginPath(); ctx.arc(2,-17,3,Math.PI*.3,Math.PI); ctx.stroke();
  // Blush
  ctx.fillStyle='rgba(255,150,150,.3)';
  ctx.beginPath(); ctx.ellipse(-10,-18,4,2.5,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(10,-18,4,2.5,0,0,Math.PI*2); ctx.fill();
  ctx.restore(); ctx.shadowBlur=0;
}

function drawUI() {
  ctx.fillStyle=C.brown; ctx.font='bold 22px sans-serif'; ctx.textAlign='left';
  ctx.fillText(`Lv. ${level}`,15,35);
  ctx.fillStyle=isFever?'#e91e63':'#e8a0c0'; ctx.font='bold 16px sans-serif';
  ctx.fillText(`${heightM}m`,15,55);
  ctx.textAlign='right';
  if(isFever){ctx.fillStyle='#e91e63';ctx.font='bold 20px sans-serif';ctx.fillText('üî•',W-80,33);}
  ctx.fillStyle=C.brown; ctx.font='bold 24px sans-serif';
  ctx.fillText(score.toLocaleString(),W-15,35);
  ctx.fillStyle=C.candy; ctx.font='16px sans-serif';
  ctx.fillText(`üç¨ ${candies}`,W-15,58);
  // Home
  ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(W-30,85,18,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='18px sans-serif'; ctx.textAlign='center'; ctx.fillText('üè†',W-30,91);
  // Fever gauge
  const gx=20,gy=90,gh=200,gw=14;
  ctx.fillStyle='#d4a017'; rr(gx-18,gy-22,50,20,6);
  ctx.fillStyle='#fff'; ctx.font='bold 10px sans-serif'; ctx.textAlign='center'; ctx.fillText('FEVER',gx+7,gy-9);
  ctx.fillStyle='rgba(0,0,0,.2)'; rr(gx,gy,gw,gh,7);
  const fh=(fever/100)*gh;
  const fg=ctx.createLinearGradient(0,gy+gh,0,gy);
  if(isFever){fg.addColorStop(0,'#ff4081');fg.addColorStop(1,'#f50057');}
  else{fg.addColorStop(0,C.bone);fg.addColorStop(1,'#d4a017');}
  ctx.fillStyle=fg; rr(gx,gy+gh-fh,gw,fh,7);
  ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.roundRect(gx,gy,gw,gh,7); ctx.stroke();
  // Pet icon
  ctx.fillStyle='#f5e6d0'; ctx.beginPath(); ctx.arc(gx+gw/2,gy+gh+18,12,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#2c2c2c';
  ctx.beginPath(); ctx.arc(gx+gw/2-3,gy+gh+15,1.5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(gx+gw/2+3,gy+gh+15,1.5,0,Math.PI*2); ctx.fill();
  // Tap hints
  if(gs===STATE.PLAY&&!jumpA.on){
    ctx.globalAlpha=.12+Math.sin(gt*.1)*.05; ctx.fillStyle='#4a9bd9';
    ctx.font='36px sans-serif'; ctx.textAlign='center';
    ctx.fillText('‚óÄ',60,H-40); ctx.fillText('‚ñ∂',W-60,H-40);
    ctx.globalAlpha=1;
  }
}

function drawJumpTxt() {
  if(!jumpTxt.on)return; jumpTxt.t--;
  if(jumpTxt.t<=0){jumpTxt.on=false;return;}
  const a=Math.min(1,jumpTxt.t/10), s=.5+(1-jumpTxt.t/30)*.8;
  ctx.save(); ctx.globalAlpha=a; ctx.translate(W/2,H/2-50); ctx.scale(s,s);
  const L=['J','U','M','P','!'], cl=['#5cb85c','#ffd700','#ff6b6b','#4a9bd9','#f8a4c8'];
  ctx.font='bold 48px sans-serif'; ctx.textAlign='center';
  let tw=0; L.forEach(l=>tw+=ctx.measureText(l).width); let dx=-tw/2;
  L.forEach((l,i)=>{
    const b=Math.sin(gt*.12+i*.8)*5, r=Math.sin(gt*.09+i)*.15;
    ctx.save(); ctx.translate(dx+ctx.measureText(l).width/2,b); ctx.rotate(r);
    ctx.strokeStyle='#fff'; ctx.lineWidth=5; ctx.strokeText(l,0,0);
    ctx.fillStyle=cl[i]; ctx.fillText(l,0,0); ctx.restore();
    dx+=ctx.measureText(l).width;
  });
  ctx.restore();
}

function drawMenu() {
  drawBG();
  ctx.fillStyle='rgba(255,248,240,.92)'; rr(W/2-150,120,300,480,30);
  // Char
  ctx.save(); ctx.translate(W/2,165); ctx.scale(1.5,1.5);
  ctx.fillStyle='#f5e6d0';
  ctx.beginPath();ctx.arc(0,0,20,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(-14,-16,8,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(14,-16,8,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#e8c4a0';
  ctx.beginPath();ctx.arc(-14,-16,5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(14,-16,5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#2d8f4e';
  ctx.beginPath();ctx.arc(0,-8,16,Math.PI,0);ctx.fill();
  rr(-17,-12,34,8,3);
  ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,-24,6,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#2c2c2c';
  ctx.beginPath();ctx.arc(-6,-2,3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(6,-2,3,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';
  ctx.beginPath();ctx.arc(-5,-3,1.2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(7,-3,1.2,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#8B6F5E';ctx.beginPath();ctx.arc(0,3,2.5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,150,150,.3)';
  ctx.beginPath();ctx.ellipse(-12,4,5,3,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(12,4,5,3,0,0,Math.PI*2);ctx.fill();
  ctx.restore();

  ctx.fillStyle=C.brown; ctx.font='bold 36px sans-serif'; ctx.textAlign='center';
  ctx.fillText('JUMPING PET',W/2,230);
  ctx.fillStyle='#d4a017'; ctx.font='bold 28px sans-serif'; ctx.fillText('Ï†êÌïëÌé´',W/2,268);
  ctx.font='24px sans-serif'; ctx.fillText('‚ùÑÔ∏è',W/2-80,205); ctx.fillText('‚ùÑÔ∏è',W/2+80,205);

  ctx.fillStyle='#888'; ctx.font='14px sans-serif'; ctx.fillText('ÏµúÍ≥† Ï†êÏàò',W/2,320);
  ctx.fillStyle='#e91e63'; ctx.font='bold 28px sans-serif'; ctx.fillText(highScore.toLocaleString(),W/2,355);

  ctx.fillStyle=C.green; rr(W/2-100,400,200,55,14);
  ctx.fillStyle='rgba(255,255,255,.2)'; rr(W/2-90,403,180,20,10);
  ctx.fillStyle='#fff'; ctx.font='bold 22px sans-serif'; ctx.fillText('ÏãúÏûëÌïòÍ∏∞',W/2,435);
  const sp=Math.sin(gt*.05)*.5+.5;
  ctx.globalAlpha=sp; ctx.fillText('‚ú®',W/2-70,430); ctx.globalAlpha=1;

  ctx.fillStyle='#aaa'; ctx.font='13px sans-serif';
  ctx.fillText('‚óÄ ÏôºÏ™Ω ÌÉ≠ = ÏôºÏ™Ω Ï†êÌîÑ | Ïò§Î•∏Ï™Ω ÌÉ≠ = Ïò§Î•∏Ï™Ω Ï†êÌîÑ ‚ñ∂',W/2,490);

  ctx.fillStyle='#e8ffe8'; rr(W/2+70,140,50,50,8);
  ctx.strokeStyle='#4caf50'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.roundRect(W/2+70,140,50,50,8); ctx.stroke();
  ctx.fillStyle='#4caf50'; ctx.font='bold 14px sans-serif'; ctx.fillText('ALL',W/2+95,165);
  ctx.font='9px sans-serif'; ctx.fillText('Ï†ÑÏ≤¥Ïù¥Ïö©Í∞Ä',W/2+95,180);
}

function drawOver() {
  ctx.fillStyle='rgba(0,0,0,.4)'; ctx.fillRect(0,0,W,H);
  ctx.fillStyle='rgba(255,248,240,.95)'; rr(W/2-130,H/2-140,260,280,24);
  ctx.fillStyle=C.brown; ctx.font='bold 28px sans-serif'; ctx.textAlign='center';
  ctx.fillText('GAME OVER',W/2,H/2-90);
  ctx.fillStyle='#888'; ctx.font='14px sans-serif'; ctx.fillText('Ï†êÏàò',W/2,H/2-50);
  ctx.fillStyle=C.brown; ctx.font='bold 32px sans-serif'; ctx.fillText(score.toLocaleString(),W/2,H/2-15);
  ctx.fillStyle='#888'; ctx.font='14px sans-serif'; ctx.fillText(`ÎÜíÏù¥: ${heightM}m | Ï∫îÎîî: ${candies}Í∞ú`,W/2,H/2+15);
  if(score>=highScore&&score>0){ctx.fillStyle='#e91e63';ctx.font='bold 16px sans-serif';ctx.fillText('üéâ NEW RECORD! üéâ',W/2,H/2+45);}
  ctx.fillStyle=C.green; rr(W/2-80,H/2+65,160,45,12);
  ctx.fillStyle='#fff'; ctx.font='bold 18px sans-serif'; ctx.fillText('Îã§ÏãúÌïòÍ∏∞',W/2,H/2+94);
  ctx.fillStyle='#ccc'; rr(W/2-80,H/2+120,160,40,12);
  ctx.fillStyle='#666'; ctx.font='bold 16px sans-serif'; ctx.fillText('Î©îÎâ¥Î°ú',W/2,H/2+146);
}

function startGame() {
  gs=STATE.PLAY; score=0; candies=0; fever=0; isFever=false; feverT=0;
  heightM=0; level=1; step=0; camY=0; particles=[]; falling=false;
  initPlats();
  const fp=platforms[0]; pet.lane=fp.lane; pet.x=fp.x; pet.y=fp.y; pet.face=1;
  jumpA.on=false; jumpTxt={on:true,t:30};
}

function loop() {
  gt++;
  if(gs===STATE.PLAY) {
    updateJump();
    const tc=pet.y-H*.55;
    if(tc<camY) camY+=(tc-camY)*.12;
    if(isFever){feverT--;if(feverT<=0){isFever=false;fever=0;}}
    platforms.forEach(p=>{if(p.broken){p.breakT+=.04;p.y+=2;}});
    particles=particles.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life-=p.dec;return p.life>0;});
    if(shakeT>0)shakeT--;
  }

  ctx.clearRect(0,0,W,H);
  if(gs===STATE.MENU){drawMenu();}
  else {
    ctx.save();
    if(shakeT>0)ctx.translate((Math.random()-.5)*shakeT*2,(Math.random()-.5)*shakeT*2);
    drawBG();
    platforms.forEach(p=>drawPlat(p));
    drawPet();
    particles.forEach(p=>{
      ctx.globalAlpha=p.life; ctx.fillStyle=p.color;
      ctx.beginPath(); ctx.arc(p.x,p.y-camY,p.sz*p.life,0,Math.PI*2); ctx.fill();
    });
    ctx.globalAlpha=1; ctx.restore();
    drawJumpTxt(); drawUI();
    if(gs===STATE.OVER)drawOver();
  }
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
